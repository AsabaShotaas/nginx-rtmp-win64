# 定义工作进程的用户身份（通常使用nobody低权限用户）
# Define user and group credentials for worker processes
user nobody;

# 设置工作进程数量（单核CPU建议设置为1）
# Set number of worker processes (1 for single-core systems)
worker_processes  1;

# 错误日志配置（当前注释掉，生产环境建议开启）
# Error log configurations (currently commented out)
#error_log  logs/error.log;               # 基础错误日志
#error_log  logs/error.log  notice;       # 记录notice级别日志
#error_log  logs/error.log  info;         # 记录info级别日志

# 进程ID文件路径（当前注释掉）
# PID file location (commented out)
#pid        logs/nginx.pid;

# 事件模块配置（控制并发连接数）
# Events module configuration
events {
    # 每个工作进程允许的最大并发连接数
    # Maximum number of simultaneous connections per worker process
    worker_connections  1024;
}

# RTMP服务配置
# RTMP server configuration
rtmp {
    server {
        # 监听RTMP协议标准端口1935
        # Listen on standard RTMP port 1935
        listen 1935; 

        # 设置数据传输块大小（影响延迟和带宽利用率）
        # Configure chunk size for data transmission
        chunk_size 4096;

        # 定义直播应用配置
        # Define 'live' application for real-time streaming
        application live {
            # 启用实时流媒体传输
            # Enable live streaming mode
            live on;
            
            # 禁用元数据发送（降低带宽占用）
            # Disable metadata sending to reduce overhead
            meta off;

            # 启用HLS切片直播（自适应码率）
            # Enable HLS (HTTP Live Streaming)
            hls on;
            # 切片时长（秒）
            # Segment length in seconds
            hls_fragment 5;
            # HLS切片存储路径
            # Storage path for HLS segments
            hls_path temp/hls; 
            # 播放列表持续时间（秒）
            # Playlist duration in seconds
            hls_playlist_length 30;

            # 开启录制功能
            # Enable recording of incoming streams
            record all;
            # 录制间隔（小时）
            # Record interval in seconds
            record_interval 3600;
            # 录制文件存储路径
            # Storage path for recorded files
            record_path temp/record;
            # 时间戳文件名格式
            # Timestamped filename format
            record_suffix -%Y-%m-%d-%H_%M_%S.flv;
            # 确保文件名唯一性
            # Ensure unique filenames
            record_unique on;
            
            # 允许所有IP推流/拉流（生产环境需限制）
            # Allow all IP addresses to publish/consume streams
            allow play all;
            allow publish all;
        }
    }
}

# HTTP服务配置
# HTTP server configuration
http {
    # 包含MIME类型定义文件
    # Include MIME type definitions
    include       mime.types;
    # 默认MIME类型（二进制流）
    # Default MIME type if not specified
    default_type  application/octet-stream;

    # 主日志格式定义
    # Main log format definition
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
     #                 '$status $body_bytes_sent "$http_referer" '
     #                 '"$http_user_agent" "$http_x_forwarded_for"';

    # 访问日志配置
    # Access log configuration
    access_log  logs/access.log  main;
    # 错误日志配置
    # Error log configuration
    error_log  logs/error.log  error;
    
    # 客户端请求体大小限制（50MB）
    # Client request body size limit
    client_max_body_size 50m;
    
    # 启用sendfile系统调用优化（高效文件传输）
    # Enable sendfile optimization
    sendfile        on;
    # 保持连接超时时间（65秒）
    # Keepalive timeout configuration
    keepalive_timeout  65;

    # HTTP服务器配置
    # HTTP server block
    server {
        # 监听HTTP 80端口
        # Listen on port 80 for HTTP requests
        listen       80;
        # 服务器域名标识
        # Server name definition
        server_name  localhost;

        # 根目录路由配置
        # Root location handler
        location / {
            # 静态文件根目录
            # Serve static files from 'html' directory
            root   html;
            # 默认索引文件
            # Default index files
            index  index.html index.htm;
        }
        
        # 实时流媒体路由（FLV格式）
        # Location for live streaming (FLV format)
        location /live {
            # 启用FLV直播支持
            # Enable FLV live streaming
            flv_live on;
            # 启用分块传输编码（支持动态流）
            # Enable chunked transfer encoding
            chunked_transfer_encoding  on;
            # 添加CORS头部（跨域访问支持）
            # Add CORS headers for cross-origin access
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Origin' '*';
            add_header Access-Control-Allow-Headers X-Requested-With;
            add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
            # 禁用缓存（实时流必须）
            # Disable caching for live streams
            add_header 'Cache-Control' 'no-cache';
        }

        # RTMP统计信息接口
        # RTMP statistics endpoint
        location /stat {
            # 显示RTMP服务器状态
            # Display RTMP server statistics
            rtmp_stat all;
            # 关联统计页面样式表
            # Specify stylesheet for statistics page
            rtmp_stat_stylesheet stat.xsl;
        }
        
        # 统计页面样式表路由
        # Statistics stylesheet location
        location /stat.xsl {
            # 从HTML目录提供样式表文件
            # Serve stylesheet from 'html' directory
            root html;
        } 
    }
}